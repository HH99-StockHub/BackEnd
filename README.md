# [Stock Hub]
![KakaoTalk_20220729_160912463](https://user-images.githubusercontent.com/105052690/181703671-b380ca2e-bc55-418a-a9f2-7264d4a77f25.jpg)

## 📢 프로젝트 소개
Stock Hub는 내가 선택한 종목에 대한 매수 의견을 공유하는 장소입니다.

다른 사용자들로부터 게시글에 대한 평가를 받는 것은 물론, 게시글 작성 시점부터의 수익률도 보여줘요!

사고 싶은 종목이 있는데, 내 생각이 맞는지 확신이 없다면 Stock Hub의 고수들에게 검증을 받아보시죠!

숨어있던 방구석 애널리스트들이 마음껏 목소리를 내는 그날까지 화이팅입니다!

## 📆 프로젝트 기간
2022/06/24 ~ 2022/08/05 <br/>
베타 서비스 배포 2022/07/29 

## 팀원소개
| Name                 | GitHub / Contact                          | Position    |
| -------------------- | --------------------------------------    | ----------- |
| Frontend Github Link | https://github.com/HH99-StockHub/FrontEnd 
| 박태형VL             |  https://github.com/bigtae1007             | FE / React  |
| 정신영               | https://github.com/sinyoung12              | FE / React  |
| Backend Github Link  | https://github.com/HH99-StockHub/BackEnd  |
| 조한울L              | https://github.com/gaius365                | BE / Spring |
| 문준호               | https://github.com/mjoonho                 | BE / Spring |
| 주 희                | https://github.com/Joo-hui                 | BE / Spring |
| Designer             |                                            | Designer   |
| 이은지               |                                            |            |


  ## 🚀  스택
 <img src="https://img.shields.io/badge/SpringBoot-6DB33F?style=flat&logo=SpringBoot&logoColor=white"/> <img src="https://img.shields.io/badge/Spring Security-6DB33F?style=flat&logo=Spring Security&logoColor=white"/> <img src="https://img.shields.io/badge/Java-007396?style=flat&logo=java&logoColor=white"/>  <img src="https://img.shields.io/badge/Python-3776AB?style=flat&logo=Python&logoColor=white"/> <img src="https://img.shields.io/badge/PyCharm-000000?style=flat&logo=PyCharm&logoColor=white"/> <img src="https://img.shields.io/badge/JWT-000000?style=flat&logo=JWT&logoColor=white"/> <img src="https://img.shields.io/badge/Flask-000000?style=flat&logo=Flask&logoColor=white"/> <img src="https://img.shields.io/badge/Gradle-02303A?style=flat&logo=Gradle&logoColor=white"/> <img src="https://img.shields.io/badge/Redis-DC382D?style=flat&logo=Redis&logoColor=white"/> <img src="https://img.shields.io/badge/STOMP-885630?style=flat&logo=stomp&logoColor=white"/> <img src="https://img.shields.io/badge/SockJS-2A2A2A?style=flat&logo=SockJS&logoColor=white"/>


  ## 🔧 툴
  <img src="https://img.shields.io/badge/GitHub-181717?style=flat&logo=GitHub&logoColor=white"/> <img src="https://img.shields.io/badge/IntelliJ IDEA-000000?style=flat&logo=IntelliJ IDEA&logoColor=white"/> <img src="https://img.shields.io/badge/Sourcetree-0052CC?style=flat&logo=Sourcetree&logoColor=white"/> <img src="https://img.shields.io/badge/Notion-000000?style=flat&logo=Notion&logoColor=white"/> <img src="https://img.shields.io/badge/Postman-FF6C37?style=flat&logo=Postman&logoColor=white"/> <img src="https://img.shields.io/badge/Slack-4A154B?style=flat&logo=Slack&logoColor=white"/> <img src="https://img.shields.io/badge/Git-F05032?style=flat&logo=Git&logoColor=white"/> <img src="https://img.shields.io/badge/MySQL-4479A1?style=flat&logo=MySQL&logoColor=white"/> <img src="https://img.shields.io/badge/Figma-F24E1E?style=flat&logo=Figma&logoColor=white"/> <img src="https://img.shields.io/badge/MongoDB-47A248?style=flat&logo=MongoDB&logoColor=white"/>
   
  ## 🖥 서버
  <img src="https://img.shields.io/badge/NGINX-009639?style=flat&logo=NGINX&logoColor=white"/> <img src="https://img.shields.io/badge/AmazonEC2-FF9900?style=flat&logo=AmazonEC2&logoColor=orange"/>
  
  ## ⚙ 주요 기능
  - **게시글 작성/삭제**: KOSPI/KOSDAQ 상장 주식을 한 가지 선택하여 그 주식에 대한 매수 의견을 게시
- **찬반 투표**: 타인의 게시글에 대해 찬성/반대의 투표를 행사 또는 수정행사 가능
- **댓글 작성/삭제**
- **수익률 기록**: 게시글이 작성 시점부터 게시글 조회 시점까지의 수익률을 표시
- **기사 표시**: 게시글 해당 종목명으로 검색했을 때 나오는 네이버 기사를 표시
- **모아보기**: 본인 및 타 유저의 게시글을 모아보기
- **게시글 검색** : 해당 키워드가 들어간 게시글 검색 기능 ( 띄어쓰기로 중복 검색어 입력 가능 )
- **인기글 게시판 등록**: 1) 3표 이상의 찬성 표를 획득 + 2) 2배수 이상의 찬성/반대 비율 달성
- **수익왕 게시판 등록**: 5% 이상의 수익률 달성
- **목표수익률**: 게시글 작성 시 목표수익률 설정 (+10%, +20%, + 30%, +50%, +100%, +150%, +200%)
- **타임 리미트**: 수익률 기록을 일정 기간 후에 멈추는 기능 (2주, 1개월, 3개월, 6개월, 1년, 2년, 3년)
- **목표 수익률**: 게시글 작성 시 목표수익률 설정 (+10%, +20%, + 30%, +50%, +100%, +150%, +200%)
- **메인 배너**: 종합 주가 지수 정보를 배너에 흐르는 형태로 게시
- **주가 차트**: 게시글 해당 종목의 1년치 선차트, 일봉차트 표시
- **랭크 시스템**: 게시글/댓글 작성 실적과 인기글 달성 업적을 점수화 해서 랭크 시스템을 적용 (신입 0점 - 초보 10점 - 중수 100점 - 고수 200점 - 지존 500점 / 게시글 작성 +30점, 댓글 작성 +5점, 인기글 달성 +50점)
- **알림 기능**: 인기글/수익왕 달성, 댓글, 찬반투표 등에 대한 알림
- **채팅방**: 로그인한 유저들끼리 토론할 수 있는 채팅방
  
  ## 🎬 배포
  https://stockhub.co.kr/
  
  ## 📽 시연 영상
  https://www.youtube.com/watch?v=44gPimI_pqI
  
  ## 📋 서비스 아키텍쳐
  ![image](https://user-images.githubusercontent.com/105042922/182091240-1c1a68bc-2ffa-4885-8f29-0cfabe55cd2a.png)
  
  ## 🛠 기술적 의사결정
  
 |적용 기술 | 기술 도입배경 |
 |---|---|
 |MongoDB | 증권 API 연결을 위해 Python을 실행하는 별도의 서버 환경을 구축했는데, 다량의 증권 데이터를 딕셔너리 형태로 저장하는 데에는 NoSQL인 MongoDB를 사용해서 Spring 서버에 연결하고자 했습니다. |
 |MySQL | Spring에서 구현하는 메인 로직에는 1대N 관계가 존재하여 관계형 DB인 MySQL을 사용했습니다. |
 |Nginx | HTTPS 연결을 위해 리버스 프록시를 수행해줄 웹서버가 필요했고, 추후 무중단 배포를 염두에 두면 Nginx를 사용하는 것이 좋다고 생각했습니다.|
 |Web Socket | 사용자들 간의 원활한 소통을 위해 실시간 알림과 전체 채팅방 기능을 제공하고자 했습니다.|
 
   ## ⚡트러블 슈팅
  
  -**[FrontEnd] 검색 시 검색 결과 데이터 useQuery 요청하기**
    
    `문제 상황`
    
    검색 결과를 캐시 데이터로 관리하고 싶었지만, useQuery는 렌더링 직후에 요청이 가고, useMutation은 캐시 데이터로 관리 할 수 없었습니다.
    
    `문제 원인`
    
    캐시 데이터를 관리하기 위해서는 useQuery를 사용해야 하지만, 함수 최상위에서 호출해야 하기 때문에 특정 상황에서 useQuery를 요청 할 수 없었습니다. 
    
    useQuery 문서를 보면서 렌더링 직후에 요청을 막을 수 있는 옵션을 찾았고, 이를 이용하면 해결이 가능 할 것 같다는 생각이 들었습니다.
    
    요청을 막는 옵션을 추가해야 했습니다. 그리고 검색 submit 이벤트 시 useQuery를 요청하면 하도록 변하면 
    
    `해결 방안`
    
    **선택지**
    
    1. mutate를 사용하여 요청을 보내고 받은 데이터를 recoil를 이용해 캐시 데이터처럼 사용
    2. enabled:false 옵션 refeching과 useState, useRef를 통해 최소한의 요청으로 원하는 값을 캐시 데이터로 사용
    
    1번 recoil을 이용하는 방법도 사용할 수 있지만, 검색이라는 기능을 자주 사용할 수 있다는 점과 데이터가 쌓일 경우 찾는 반복문에 크기, 데이터의 최신 상태를 판단하기 어렵다는 점에서 useQuery로 요청하는 게 적절하다고 생각했습니다.
    
    해결하기 위해 useState으로만 상태관리, useRef만 이용하여 query요청, 전역 상태관리 라이브러리 이용, useState와 useRef를 동시에 이용하는 다양한 방법을 실행해 봤을 때, 해결은 가능했지만, 효율적인 방법이라 생각하지 못했고, useState와 useRef를 동시에 사용하는 방법이 제일 적절하다고 판단했습니다.
    
    
 -**[FrontEnd] 도메인 주소와 S3 주소에 버전이 다른 이슈**
    
    `문제 상황`
    
    소켓 테스트를 위해 일부 컴포넌트를 주석으로 변경하여 배포를 한 후 동작하는 것을 확인하고 완성된 파일을 build하여 S3에 배포했습니다.
    도메인에서는 변경사항이 제대로 반영되지 않았고, s3 도메인에서는 변경사항이 반영됐습니다.
    
    `문제 원인`
    
    가설 1. 도메인까지 연결되는 시간이 걸린다.
    가설 2. s3 배포를 할 때 도메인에도 올리기 위해서는 추가적으로 어떤 행동을 해야 한다.
    
    **가설 확인**
    
    가설 1 확인 . 단순히 기달려봤습니다.
    가설 2 확인 . 가설 1을 확인하기 위해 기다리면서 구글 검색을 진행했습니다. s3와 도메인에 차이에는 route 53과 cloudfront에 영향을 받았고, 만일 두 버전에 차이가 있다면, 이 두 가지 중 문제가 있다고 생각했습니다. 그리고 cloudfront 관련 검색에서 캐시 데이터를 삭제해야 한다는 소스를 발견하여 문제 원인을 파악했습니다.
    
    `해결 방안`
    
    1 . cloudfront에서 사용한 배포에 무효화를 전체 경로로 설정했습니다.
    2 . github action을 이용하여 main 브런치에 변화가 있을 때 자동 배포 및 캐시 데이터 초기화 명령을 수행하도록 설정했습니다.
    
    
    
 -**[BackEnd] 추천/비추천 투표 비정상 작동**
    
    `문제 상황`
    
    하나의 게시글을 놓고 동시에 여러 명이서 “추천"과 “비추천" 투표를 계속 눌렀을 때 가끔 추천 수나 비추천 수가 “-1” 등 나올 수 없는 숫자가 나오는 상황이 벌어졌습니다. 
    
    `문제 원인`
    
    추천/비추천 투표 로직상 게시글을 “articleRepository”에서 불러온 후 일련의 테스트 과정을 조건문으로 거치고 “article.setVoteUpCount(article.getVoteUpCount() + 1)”의 방식으로 추천 수를 업데이트 했습니다. 그런데 1번 사용자의 로직이 다 돌기 전에 2번 사용자가 투표를 하게 되면 오류가 발생하는 것이었습니다.
    
    `해결 방안`
    
    1. Message Queue를 적용하여 짧은 순간에 들어오는 요청도 순차적으로 처리하는 방안 → 공부 중
    2. “voteUpCount”를 매뉴얼로 +1, -1 처리하지 않고 “voteUpRepository”에서 관련 투표 수를 카운트해서 set하는 방안 → 채택 예정
    
    
    
  ## 🧾 API 및 ERD 설계
  API 설계 : https://www.notion.so/be889f10852c4aed91ba2bd00b5c4f20?v=42e0adb20f9147648addf40aad7e0301
